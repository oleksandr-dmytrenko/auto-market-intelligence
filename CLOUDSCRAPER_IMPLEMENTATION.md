# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è Cloudscraper –¥–ª—è Bidfax

## ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. –ù–æ–≤—ã–π –º–æ–¥—É–ª—å `bidfax_scraper_cloudscraper.py`
- ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –º–µ—Ç–æ–¥ —Å–∫—Ä–∞–ø–∏–Ω–≥–∞
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫—É `cloudscraper` (—É–∂–µ –≤ requirements.txt)
- ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç Chrome/Selenium
- ‚úÖ –ë—ã—Å—Ç—Ä–µ–µ —á–µ–º Selenium
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ–±—Ö–æ–¥ Cloudflare challenge

### 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `auction_fetcher.py`
- ‚úÖ Cloudscraper –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ **–ø–µ—Ä–≤—ã–π –º–µ—Ç–æ–¥** (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
- ‚úÖ Selenium –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ **fallback** –µ—Å–ª–∏ cloudscraper –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –º–µ—Ç–æ–¥–∞–º–∏

### 3. –£–ª—É—á—à–µ–Ω–∏—è
- ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ cookies —Å –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–∞–º–∏
- ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ 403
- ‚úÖ –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞

## üìã –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –º–µ—Ç–æ–¥–æ–≤:

1. **Cloudscraper** (–ø–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞)
   - –ë—ã—Å—Ç—Ä—ã–π
   - –ù–µ —Ç—Ä–µ–±—É–µ—Ç Chrome
   - –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ–±—Ö–æ–¥ Cloudflare

2. **Selenium** (fallback)
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –µ—Å–ª–∏ cloudscraper –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª
   - –¢—Ä–µ–±—É–µ—Ç Chrome driver
   - –ú–µ–¥–ª–µ–Ω–Ω–µ–µ
   - –ë–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤

### –ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç—ã:

```
fetch_bidfax_listings()
  ‚Üì
–ü—Ä–æ–±—É–µ—Ç cloudscraper
  ‚Üì
–£—Å–ø–µ—à–Ω–æ? ‚Üí –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
  ‚Üì
–ù–µ—É–¥–∞—á–∞? ‚Üí –ü—Ä–æ–±—É–µ—Ç Selenium (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
  ‚Üì
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
```

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ (—á–µ—Ä–µ–∑ auction_fetcher):

```python
from workers.auction_fetcher import AuctionFetcher
from workers.rate_limiter import RateLimiter
import redis

redis_client = redis.from_url('redis://redis:6379/0')
rate_limiter = RateLimiter(redis_client)
fetcher = AuctionFetcher(rate_limiter)

vehicles = fetcher.fetch_bidfax_listings({
    'make': 'Toyota',
    'model': 'Camry',
    'year': 2020
}, limit=1)
```

### –ü—Ä—è–º–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ cloudscraper:

```python
from workers.bidfax_scraper_cloudscraper import BidfaxCloudscraper

scraper = BidfaxCloudscraper()
vehicles = scraper.scrape_listings('Toyota', 'Camry', 2018, 2022, limit=1)
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

```bash
docker compose exec python_workers python /app/test_cloudscraper.py
```

## ‚ö†Ô∏è –¢–µ–∫—É—â–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### Cloudflare –≤—Å–µ –µ—â–µ –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å

–î–∞–∂–µ —Å cloudscraper, Bidfax.info –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å 403 Forbidden. –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è —Å—Ç—Ä–æ–≥–æ–π –∑–∞—â–∏—Ç—ã Cloudflare.

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
- IP –∞–¥—Ä–µ—Å –≤ —á–µ—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ
- –°–ª–∏—à–∫–æ–º —á–∞—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- Cloudflare –æ–±–Ω–æ–≤–∏–ª –∑–∞—â–∏—Ç—É

**–†–µ—à–µ–Ω–∏—è:**
1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ–∫—Å–∏ (–¥–∞–∂–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –º–æ–≥—É—Ç –ø–æ–º–æ—á—å)
2. –£–≤–µ–ª–∏—á–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∏ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Selenium fallback (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π)
4. –†—É—á–Ω–æ–π —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –∑–∞–¥–µ—Ä–∂–µ–∫:

–í `bidfax_scraper_cloudscraper.py` –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å:

```python
# –£–≤–µ–ª–∏—á–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
time.sleep(10 * (attempt + 1))  # –£–≤–µ–ª–∏—á—å—Ç–µ –º–Ω–æ–∂–∏—Ç–µ–ª—å

# –£–≤–µ–ª–∏—á–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
time.sleep(2)  # –£–≤–µ–ª–∏—á—å—Ç–µ –¥–æ 5-10 —Å–µ–∫—É–Ω–¥
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–∫—Å–∏:

Cloudscraper –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø—Ä–æ–∫—Å–∏:

```python
proxies = {
    'http': 'http://proxy:port',
    'https': 'http://proxy:port'
}
response = self.scraper.get(url, proxies=proxies, timeout=30)
```

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–µ—Ç–æ–¥–æ–≤

| –ú–µ—Ç–æ–¥ | –°–∫–æ—Ä–æ—Å—Ç—å | –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å | –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è | –°—Ç–æ–∏–º–æ—Å—Ç—å |
|-------|----------|------------|------------|-----------|
| **Cloudscraper** | ‚ö°‚ö°‚ö° –ë—ã—Å—Ç—Ä—ã–π | ‚≠ê‚≠ê –°—Ä–µ–¥–Ω—è—è | –ù–µ—Ç | üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω–æ |
| **Selenium** | ‚ö° –ú–µ–¥–ª–µ–Ω–Ω—ã–π | ‚≠ê‚≠ê‚≠ê –í—ã—Å–æ–∫–∞—è | Chrome | üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω–æ |
| **–ü—Ä–æ–∫—Å–∏** | ‚ö°‚ö° –°—Ä–µ–¥–Ω–∏–π | ‚≠ê‚≠ê‚≠ê –í—ã—Å–æ–∫–∞—è | –ü—Ä–æ–∫—Å–∏ | üí∞ –ü–ª–∞—Ç–Ω–æ |

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ cloudscraper (–±—ã—Å—Ç—Ä–æ, –±–µ—Å–ø–ª–∞—Ç–Ω–æ)
2. **–î–ª—è production**: –ö–æ–º–±–∏–Ω–∏—Ä—É–π—Ç–µ cloudscraper + Selenium fallback
3. **–ü—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞—Ö**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–æ–∫—Å–∏ –∏–ª–∏ —É–≤–µ–ª–∏—á–∏–≤–∞–π—Ç–µ –∑–∞–¥–µ—Ä–∂–∫–∏
4. **–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**: –†—É—á–Ω–æ–π —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ Rails console

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ Cloudscraper —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
2. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ auction_fetcher
3. ‚úÖ Fallback –Ω–∞ Selenium —Ä–∞–±–æ—Ç–∞–µ—Ç
4. ‚è≥ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å –ø—Ä–æ–∫—Å–∏)
5. ‚è≥ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–¥–µ—Ä–∂–µ–∫ –∏ retry –ª–æ–≥–∏–∫–∏

## üîç –û—Ç–ª–∞–¥–∫–∞

–ï—Å–ª–∏ cloudscraper –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
   ```bash
   docker compose logs python_workers | grep cloudscraper
   ```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ cloudscraper —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:
   ```bash
   docker compose exec python_workers pip list | grep cloudscraper
   ```

3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞–ø—Ä—è–º—É—é:
   ```bash
   docker compose exec python_workers python /app/test_cloudscraper.py
   ```

4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ fallback –Ω–∞ Selenium:
   - –ï—Å–ª–∏ cloudscraper –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –¥–æ–ª–∂–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è Selenium




