# Name of your application. Used to uniquely configure containers.
service: rails_api

# Name of the container image (use your-user/app-name on external registries).
# This will be updated by GitHub Actions workflow with DOCKER_USERNAME
image: rails_api

# Deploy to these servers.
# Replace with your VPS IP address or domain
servers:
  web:
    hosts:
      - ${DEPLOY_HOST}
    options:
      user: ${DEPLOY_USER:-root}

# Enable SSL auto certification via Let's Encrypt
proxy:
  ssl: true
  host: ${DEPLOY_DOMAIN:-bidly.tech}
  # If using Cloudflare, set encryption mode to "Full"
  # ssl_cert: /path/to/cert.pem
  # ssl_key: /path/to/key.pem

# Where you keep your container images.
# Using Docker Hub (you can switch to ghcr.io if preferred)
registry:
  server: docker.io
  username:
    - DOCKER_USERNAME
  password:
    - DOCKER_PASSWORD

# Inject ENV variables into containers (secrets come from .kamal/secrets).
env:
  secret:
    - RAILS_MASTER_KEY
    - DATABASE_URL
    - REDIS_URL
    - KAFKA_BROKERS
    - TELEGRAM_BOT_TOKEN
  clear:
    RAILS_ENV: production
    RAILS_LOG_LEVEL: info
    PORT: 3000
    RAILS_MAX_THREADS: 5
    WEB_CONCURRENCY: 2
    # Run the Solid Queue Supervisor inside the web server's Puma process to do jobs.
    SOLID_QUEUE_IN_PUMA: true

# Aliases are triggered with "bin/kamal <alias>". You can overwrite arguments on invocation:
aliases:
  console: app exec --interactive --reuse "bin/rails console"
  shell: app exec --interactive --reuse "bash"
  logs: app logs -f
  dbc: app exec --interactive --reuse "bin/rails dbconsole --include-password"

# Use a persistent storage volume for Active Storage files.
volumes:
  - "rails_api_storage:/rails/storage"

# Configure the image builder.
builder:
  arch: amd64
  # Build locally or on CI
  # remote: ssh://docker@docker-builder-server

# Use a different ssh user than root
ssh:
  user: ${DEPLOY_USER:-root}
  keys:
    - ${DEPLOY_SSH_KEY:-~/.ssh/id_rsa}

# Use accessory services (secrets come from .kamal/secrets).
accessories:
  db:
    image: postgres:15-alpine
    host: ${DEPLOY_HOST}
    port: "127.0.0.1:5432:5432"
    env:
      clear:
        POSTGRES_DB: car_bot_production
      secret:
        - POSTGRES_PASSWORD
    directories:
      - postgres_data:/var/lib/postgresql/data
    options:
      user: ${DEPLOY_USER:-root}
  
  redis:
    image: redis:7-alpine
    host: ${DEPLOY_HOST}
    port: "127.0.0.1:6379:6379"
    directories:
      - redis_data:/data
    files:
      - redis/redis.conf:/usr/local/etc/redis/redis.conf
    cmd: redis-server /usr/local/etc/redis/redis.conf
    options:
      user: ${DEPLOY_USER:-root}
  
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    host: ${DEPLOY_HOST}
    port: "127.0.0.1:2181:2181"
    env:
      clear:
        ZOOKEEPER_CLIENT_PORT: 2181
        ZOOKEEPER_TICK_TIME: 2000
    options:
      user: ${DEPLOY_USER:-root}
  
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    host: ${DEPLOY_HOST}
    port: "127.0.0.1:9092:9092"
    env:
      clear:
        KAFKA_BROKER_ID: 1
        KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
        KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://${DEPLOY_HOST}:9092,PLAINTEXT_INTERNAL://kafka:29092
        KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_INTERNAL:PLAINTEXT
        KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT_INTERNAL
        KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
        KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
    options:
      user: ${DEPLOY_USER:-root}
