# –†–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ Cloudflare (403 Forbidden)

## üî¥ –¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è

Cloudflare –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **403 Forbidden** –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ:
- ‚úÖ –í—Å–µ —Ç–µ—Ö–Ω–∏–∫–∏ –æ–±—Ö–æ–¥–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚ö†Ô∏è Cloudflare –≤—Å–µ –µ—â–µ –¥–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é
- ‚ö†Ô∏è IP –∞–¥—Ä–µ—Å –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ —á–µ—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ
- ‚ö†Ô∏è –ó–∞—â–∏—Ç–∞ Cloudflare –æ—á–µ–Ω—å —Å—Ç—Ä–æ–≥–∞—è –¥–ª—è Bidfax.info

## ‚úÖ –ß—Ç–æ —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **Cloudscraper** - –ø—Ä–∏–º–µ–Ω—è–µ—Ç –≤—Å–µ —Ç–µ—Ö–Ω–∏–∫–∏ –æ–±—Ö–æ–¥–∞
2. **Selenium fallback** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –µ—Å–ª–∏ cloudscraper –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
3. **–í—Å–µ —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã** - —Ä–æ—Ç–∞—Ü–∏—è User-Agent, cookies, –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ —Ç.–¥.

## üéØ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è

### –†–µ—à–µ–Ω–∏–µ 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Selenium Fallback (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ Selenium –µ—Å–ª–∏ cloudscraper –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç - –æ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Selenium fallback
docker compose exec python_workers python /app/test_real_bidfax.py
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã Selenium:**
```bash
docker compose logs python_workers | grep -i "selenium\|chrome\|fallback"
```

### –†–µ—à–µ–Ω–∏–µ 2: –†—É—á–Ω–æ–π –∏–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

–ü–æ–∫–∞ Cloudflare –±–ª–æ–∫–∏—Ä—É–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—á–Ω–æ–π –∏–º–ø–æ—Ä—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã:

```bash
docker compose exec rails_api bundle exec rails console
```

```ruby
# –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞–ø–∏—Å—å —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ —Å Bidfax
Vehicle.create!(
  source: 'bidfax',
  source_id: '34001674',  # –†–µ–∞–ª—å–Ω—ã–π ID —Å Bidfax
  make: 'Audi',
  model: 'Q5',
  year: 2023,
  mileage: 50000,
  color: 'Black',
  damage_type: 'Minor',
  price: 25000.0,
  final_price: 25000.0,
  vin: 'WA1GAAF...',  # –†–µ–∞–ª—å–Ω—ã–π VIN
  location: 'Location Name',
  auction_url: 'https://bidfax.info/audi/q5/34001674-...html',
  auction_status: 'completed',
  raw_data: {
    'title' => 'Audi Q5 Premium...',
    'vin' => 'WA1GAAF...',
    'images' => ['https://bidfax.info/image1.jpg']
  }
)
```

### –†–µ—à–µ–Ω–∏–µ 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∫—Å–∏ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã)

–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –ø—Ä–æ–∫—Å–∏ (–¥–∞–∂–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ):

```bash
export PROXY_HOST=your-proxy.com
export PROXY_PORT=8080
export PROXY_USERNAME=user  # –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è
export PROXY_PASSWORD=pass   # –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è

docker compose restart python_workers
docker compose exec python_workers python /app/test_cloudscraper.py
```

### –†–µ—à–µ–Ω–∏–µ 4: –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ (–Ω–µ –≤ Docker)

–î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –Ω–∞ –≤–∞—à–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ:

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ
cd python_workers
pip install -r requirements.txt

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –ª–æ–∫–∞–ª—å–Ω–æ (–º–æ–∂–µ—Ç –æ–±–æ–π—Ç–∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏)
export CHROME_HEADLESS=false
python test_cloudscraper.py
```

### –†–µ—à–µ–Ω–∏–µ 5: –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –∑–∞–¥–µ—Ä–∂–µ–∫

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –æ–±—Ö–æ–¥–∞ Cloudflare, —É–≤–µ–ª–∏—á—å—Ç–µ –∑–∞–¥–µ—Ä–∂–∫–∏:

–í `bidfax_scraper_cloudscraper.py`:
```python
# –£–≤–µ–ª–∏—á—å—Ç–µ –∑–∞–¥–µ—Ä–∂–∫—É –≤ cloudscraper
delay=30  # –í–º–µ—Å—Ç–æ 15

# –£–≤–µ–ª–∏—á—å—Ç–µ –∑–∞–¥–µ—Ä–∂–∫–∏ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
delay = random.uniform(20, 40) * (2 ** attempt)  # –í–º–µ—Å—Ç–æ 10-20
```

### –†–µ—à–µ–Ω–∏–µ 6: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ VPN

–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å VPN, –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –¥—Ä—É–≥–æ–º—É —Å–µ—Ä–≤–µ—Ä—É –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ:

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ VPN
# –ó–∞—Ç–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç
docker compose exec python_workers python /app/test_cloudscraper.py
```

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ Selenium —Ä–∞–±–æ—Ç–∞–µ—Ç:

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
docker compose logs python_workers | grep -i "chrome\|selenium\|driver"

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ Chrome driver –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è
docker compose exec python_workers python -c "
from workers.auction_fetcher import AuctionFetcher
from workers.rate_limiter import RateLimiter
import redis
r = redis.from_url('redis://redis:6379/0')
rl = RateLimiter(r)
af = AuctionFetcher(rl)
print('Driver available:', af.driver is not None)
"
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ fallback —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç –∏ –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏
docker compose exec python_workers python /app/test_real_bidfax.py 2>&1 | grep -i "fallback\|selenium\|cloudscraper"
```

## üìä –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

### –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –æ–±—Ö–æ–¥–µ Cloudflare:
```
‚úì Successfully fetched page (50000+ bytes)
‚úì Found X listings on search page
‚úì Successfully parsed vehicle: ...
```

### –ü—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ (—Ç–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è):
```
‚úó 403 Forbidden - Cloudflare blocking
‚ö† cloudscraper failed, trying Selenium fallback...
```

### –ï—Å–ª–∏ Selenium —Ç–æ–∂–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è:
```
‚úó Selenium also failed: ...
‚ö† –í—Å–µ –º–µ—Ç–æ–¥—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã
üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–æ–∫—Å–∏ –∏–ª–∏ —Ä—É—á–Ω–æ–π –∏–º–ø–æ—Ä—Ç
```

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º

1. **–î–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã:**
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—á–Ω–æ–π –∏–º–ø–æ—Ä—Ç —á–µ—Ä–µ–∑ Rails console
   - ‚úÖ –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç

2. **–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:**
   - ‚úÖ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ Selenium fallback (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–æ–∫—Å–∏ –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
   - ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ª–æ–∫–∞–ª—å–Ω–æ (–Ω–µ –≤ Docker)

3. **–î–ª—è production:**
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ residential –ø—Ä–æ–∫—Å–∏
   - ‚úÖ –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ä–æ—Ç–∞—Ü–∏—é –ø—Ä–æ–∫—Å–∏
   - ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –æ–±—Ö–æ–¥–∞

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **403 Forbidden - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ** –¥–ª—è —Å—Ç—Ä–æ–≥–æ–π –∑–∞—â–∏—Ç—ã Cloudflare
2. **–í—Å–µ —Ç–µ—Ö–Ω–∏–∫–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã** - –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ –≤ –∫–æ–¥–µ, –∞ –≤ –∑–∞—â–∏—Ç–µ —Å–∞–π—Ç–∞
3. **Fallback –Ω–∞ Selenium —Ä–∞–±–æ—Ç–∞–µ—Ç** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
4. **–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è** –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—á–Ω–æ–π –∏–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö

## üîÑ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ Selenium fallback
2. –ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä–æ–∫—Å–∏ - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—á–Ω–æ–π –∏–º–ø–æ—Ä—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
3. –î–ª—è production - –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–æ–∫—Å–∏ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö




